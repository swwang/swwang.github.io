<!DOCTYPE html>
<html lang="en">
  <head>
    <title>sbvote</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="HandheldFriendly" content="true">
    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Parisienne|Grandstander:100,300,500">

    <style>
      body {
        font-size: 3vmin;
        font-family: "Grandstander";
      }

      #content {
        position: fixed;
        left: 20%;
        width: 60%;
        height: 100%;
      }

      @media screen and (max-width: 1024px) {
        #content {
          left: 5%;
          width: 90%;
          font-size: 3.3vmin;
        }
      }

      #div-login, #div-game {
        width: 100%;
        height: 100%;
        position: relative;
      }

      #form-login {
        position: relative;

        font-size: 1.5em;

        width: 80%;
        top: 45%;

        margin: 0 auto;
        text-align: center;

        transform: translateY(-50%);
      }

      #input-name {
        text-align: center;
        margin: 0 auto;
        margin-bottom: 0.5em;
        width: 100%;
        max-width: 16em;
      }

      #submit-login:hover {
        cursor: pointer;
      }

      #div-game, #div-vote, #div-stats {
        display: none;
      }

      #div-game {
        margin-top: 1.5em;
      }

      #div-question {
        text-align: center;
        font-size: 3em;
        font-weight: bold;

        margin-bottom: 0.3em;
      }

      #explanation {
        font-size: 0.3em;
      }

      #div-score {
        text-align: center;
        font-size: 1.5em;
      }
      #correct-answer, #wrong-answer {
        display: none;
        opacity: 0;
      }

      #sharon-button {
        background: no-repeat url("./img/vote_sharon.png") left, #ae47ff;
        background-size: contain;
      }
      .sharon-selected {
        box-shadow: 0 0 1em #ae47ff;
        transform: scale(1.1);
      }

      #brian-button {
        background: no-repeat url("./img/vote_brian.png") left, #ff4f4f;
        background-size: contain;
      }
      .brian-selected {
        box-shadow: 0 0 1em #ff4f4f;
        transform: scale(1.1);
      }

      .vote-button {
        padding-top: 1.5em;
        padding-bottom: 1.5em;
        padding-left: 1em;
        padding-right: 0.5em;
        font-size: 2em;
        margin-bottom: 0.5em;
        text-align: center;
        border-radius: 1em;

        background-repeat: no-repeat;
        background-size: contain;

        transition: all 0.2s ease-in;
      }

      .vote-button:hover {
        cursor: pointer;
      }

      .button-votes {
        float: right;
        margin-right: 0.3em;
        visibility: hidden;
      }

      .new-voter {
        font-size: 0.3em;
        opacity: 0;

        height: 0;
        overflow: visible;

        transition: all 0.2s ease-in;
      }

      .pop {
        animation: pop 3s infinite;
      }

      .pop-once {
        animation: pop-once 2s;
      }

      .pop-fade {
        animation: pop-fade 2s;
      }

      @keyframes pop {
        0%, 100% { font-size: 0em; opacity: 0; }
        15%, 85% { font-size: 0.4em; opacity: 1; }
      }

      @keyframes pop-once {
        0%, 100% { font-size: 1em; }
        15%, 85% { font-size: 1.5em; }
      }

      @keyframes pop-fade {
        0%, 100% { font-size: 0em; }
        15%, 85% { font-size: 2em; }
        0%, 85% { opacity: 1; }
        100% { opacity: 0; }
      }
    </style>
  </head>

  <body>
    <div id="content">
      <div id="div-login">
        <form id="form-login" action="about:blank" target="iframe-empty" autocomplete="off">
          <input id="input-name" type="text" placeholder="Who's playing?" required>
          <br>
          <input id="submit-login" type="submit" value="Join">
        </form>
      </div>
      <div id="div-game">
        <div id="div-question">
          <div id="question">Welcome Friend!<br><br><div id="explanation">Who knows the sbteam best?<br><br>We'll be asking everyone a series of trivia questions related to the bride and groom. Score points by picking the correct answer.<br><br>Some questions are opinion questions and will not have a "correct" answer. In these cases, vote with the majority to score a point.<br><br>Top 3 with the most points at the end win a prize!</div></div>
        </div>
        <div id="div-vote">
          <div id="sharon-button" class="vote-button">
            <span class="button-text">Sharon<span id="sharon-votes" class="button-votes"></span>
              <div id="sharon-voter" class="new-voter">Voter</div>
            </span>
          </div>
          <div id="brian-button" class="vote-button">
            <span class="button-text">Brian<span id="brian-votes" class="button-votes"></span>
              <div id="brian-voter" class="new-voter">Voter</div>
            </span>
          </div>
        </div>
        <div id="div-stats">
          <div id="div-score">Your score: <span id="score">0</span><br><span id="correct-answer">Correct :)</span><span id="wrong-answer">Wrong :(</span></div>
        </div>
      </div>
    </div>
  </body>

  <script>
    const host = location.hostname === "localhost" ? "http://localhost:3000" : "https://perch.birdtown.net";
    const interval = 3000;
    let voteEnabled = false;

    function register(name, id) {
      fetch(`${host}/register?n=${name}&id=${id}`, { method: "PUT" })
        .then((response) => {
          if (response.ok) {
            console.log("Register:", response);
            return response.json;            
          } else {
            setQuestion("Failed to login! Please refresh and try again.")
          }
        });
    }

    function vote(answer) {
      fetch(`${host}/vote?v=${version}&a=${answer}&id=${id}`, { method: "PUT" })
        .then((response) => response.json(), () => {})
        .then((data) => {
          refresh();
        }, () => {});
    }

    let divLogin = document.getElementById("div-login");
    let divGame = document.getElementById("div-game");
    let loginForm = document.getElementById("form-login");
    let inputName = document.getElementById("input-name");
    let name = "Player";
    let id = "" + Math.floor(1000000 * Math.random());
    loginForm.onsubmit = () => {
      name = inputName.value.trim();

      divLogin.style.display = "none";
      divGame.style.display = "block";

      register(name, id);

      console.log("Logged in! Name: %s, ID: %s", name, id);
      return false;
    }

    const params = new URLSearchParams(window.location.search);
    if (params.has("id")) {
      const idParam = params.get("id");
      if (idParam.length > 0) {
        id = idParam;
      }
    }
    if (params.has("name")) {
      const nameParam = params.get("name");
      if (nameParam.length > 0) {
        document.getElementById("input-name").value = nameParam;
      }
    }

    let question = document.getElementById("question");
    let version = 0;
    let score = 0;

    let names = new Map();
    let brianQueue = [];
    let sharonQueue = [];

    let sharonButton = document.getElementById("sharon-button");
    let brianButton = document.getElementById("brian-button");

    let divVote = document.getElementById("div-vote");
    let divStats = document.getElementById("div-stats");
    let divScore = document.getElementById("div-score");
    let spanScore = document.getElementById("score");
    let correctAnswer = document.getElementById("correct-answer");
    let wrongAnswer = document.getElementById("wrong-answer");

    let brianVotes = document.getElementById("brian-votes");
    let brianVoter = document.getElementById("brian-voter");
    let sharonVotes = document.getElementById("sharon-votes");
    let sharonVoter = document.getElementById("sharon-voter");

    function askQuestion(questionText, questionVersion, currentScore) {
        setQuestion(questionText);

        voteEnabled = true;

        divVote.style.display = "block";
        divStats.style.display = "block";

        if (questionVersion >= 2) {
          spanScore.textContent = currentScore + "/" + (questionVersion - 1);

          if (version === questionVersion - 1) {
            if (score === Number(currentScore)) {
              correctAnswer.style.display = "none";

              wrongAnswer.style.display = "inline";
              wrongAnswer.classList.remove("pop-fade");
              wrongAnswer.offsetHeight;
              wrongAnswer.classList.add("pop-fade");
            } else {
              wrongAnswer.style.display = "none";

              correctAnswer.style.display = "inline";
              correctAnswer.classList.remove("pop-fade");
              correctAnswer.offsetHeight;
              correctAnswer.classList.add("pop-fade");
            }
          }
        }

        sharonButton.classList.remove("sharon-selected");
        sharonButton.style.background = `no-repeat url("./img/vote_sharon.png") left, linear-gradient(to right, #ae47ff 100%)`
        sharonButton.style.backgroundSize = "contain";
        brianButton.classList.remove("brian-selected");
        brianButton.style.background = `no-repeat url("./img/vote_brian.png") left, linear-gradient(to right, #ff4f4f 100%)`
        brianButton.style.backgroundSize = "contain";

        brianVotes.style.visibility = "hidden";
        sharonVotes.style.visibility = "hidden";

        names.clear();
        brianQueue = [];
        sharonQueue = [];

        version = questionVersion;
        score = Number(currentScore);
    }

    function setQuestion(questionText) {
        question.textContent = questionText;
        if (questionText.length >= 40) {
          question.style.fontSize = "0.5em";
        } else if (questionText.length >= 20) {
          question.style.fontSize = "0.75em";
        } else {
          question.style.fontSize = "1em";
        }
    }

    function populateStats(data) {
      if (voteEnabled) {
        return;
      }

      let brian = [];
      let sharon = [];

      for (const key in data) {
        if (!data.hasOwnProperty(key)) {
          continue;
        }

        if (key === "Brian") {
          brian = data[key];
        }
        if (key === "Sharon") {
          sharon = data[key];
        }
      }

      const numVotes = brian.length + sharon.length;

      if (numVotes === 0) {
        return;
      }

      if (!names.has("Brian")) {
        names.set("Brian", new Set());
      }
      if (!names.has("Sharon")) {
        names.set("Sharon", new Set());
      }
      brian.forEach((name) => {
        if (names.get("Brian").has(name)) {
          return;
        }
        brianQueue.push(name);
        names.get("Brian").add(name);
      });
      sharon.forEach((name) => {
        if (names.get("Sharon").has(name)) {
          return;
        }
        sharonQueue.push(name);
        names.get("Sharon").add(name);
      });

      brianVotes.style.visibility = "visible";
      sharonVotes.style.visibility = "visible";

      brianVotes.textContent = brian.length;
      sharonVotes.textContent = sharon.length;

      let percent = Math.round(brian.length / numVotes * 100);
      brianButton.style.background = `no-repeat url("./img/vote_brian.png") left, linear-gradient(to right, #ff4f4f ${percent}%, #e08484 ${percent+1}%)`
      brianButton.style.backgroundSize = "contain";

      percent = Math.round(sharon.length / numVotes * 100);
      sharonButton.style.background = `no-repeat url("./img/vote_sharon.png") left, linear-gradient(to right, #ae47ff ${percent}%, #b78bd9 ${percent+1}%)`
      sharonButton.style.backgroundSize = "contain";
    }

    sharonButton.onclick = () => {
      if (!voteEnabled) {
        return;
      }
      sharonButton.classList.add("sharon-selected");
      vote("Sharon");
      voteEnabled = false;
    }
    brianButton.onclick = () => {
      if (!voteEnabled) {
        return;
      }
      brianButton.classList.add("brian-selected");
      vote("Brian");
      voteEnabled = false;
    }

    function refresh() {
      console.log("Refreshing...", version, id);
      fetch(`${host}/refresh?v=${version}&id=${id}`, { method: "GET" })
        .then((response) => response.json(), () => {})
        .then((data) => {
          if (!data) {
            return;
          }
          if (data.hasOwnProperty("question") && data.hasOwnProperty("version")) {
            askQuestion(data["question"], Number(data["version"]), Number(data["score"]));
          } else {
            populateStats(data);
          }
        }, () => {});
    }
    setInterval(() => {
      refresh();

      let brianVoters = [];
      for (let i = 0; i < 3; ++i) {
        if (brianQueue.length <= 0) {
          break;
        }
        brianVoters.push(brianQueue.pop());
      }

      brianVoter.classList.remove("pop");
      if (brianVoters.length > 0) {
        brianVoter.textContent = "+" + brianVoters.join(", ");
        brianVoter.classList.add("pop");
      }

      let sharonVoters = [];
      for (let i = 0; i < 3; ++i) {
        if (sharonQueue.length <= 0) {
          break;
        }
        sharonVoters.push(sharonQueue.pop());
      }

      sharonVoter.classList.remove("pop");
      if (sharonVoters.length > 0) {
        sharonVoter.textContent = "+" + sharonVoters.join(", ");
        sharonVoter.classList.add("pop");
      }
    }, interval);
  </script>
</html>
