<!DOCTYPE html>
<html lang="en">
  <head>
    <title>sbhost</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="HandheldFriendly" content="true">
    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Parisienne|Grandstander:100,300,500">

    <style>
      body {
        font-size: 3vmin;
        font-family: "Grandstander";
      }

      label {
        margin-right: 0.3em;
      }

      #div-content {
        width: 90%;
        margin: 0 auto;
      }

      #div-question {
        margin: 0 auto;
        padding: 1em;
        text-align: center;

        font-size: 2em;
      }

      #question-input {
        font-size: 0.8em;
        margin-bottom: 0.5em;
      }

      #question-submit:hover {
        cursor: pointer;
      }

      #stats {
        text-align: center;
      }

      #samples {
        text-align: center;
        margin-top: 0.3em;
        margin-bottom: 2em;
      }

      #samples-title, #standings-title, #answers-title {
        font-weight: bold;
      }

      #standings, #current-answers {
        font-size: 0.7em;
        margin-bottom: 1em;
      }

      #standings {
        white-space: pre;
      }

      .question {
        margin-top: 0.3em;
        font-weight: bold;
      }

      .answer {
        font-size: 0.7em;
      }

      .answer-box {
        font-size: 0.5em;
        line-height: 1em;
      }

      .sample {
        border: 1px solid;
        border-radius: 0.3em;
        padding: 0.5em;
        width: 70%;
        margin: 0.5em auto;
        font-size: 0.8em;
      }
      .sample:hover {
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="div-content">
      <div id="div-question">
        <form id="question-form" action="about:blank" target="iframe-empty" autocomplete="off" onsubmit="return false;">
          <input id="question-input" type="text" placeholder="Question" required>
          <br>
          <span class="answer-box">
            <span>Answer:</span>
            <input type="radio" id="radio-sharon" name="question-answer" value="Sharon">
            <label for="radio-sharon">Sharon</label>
            <input type="radio" id="radio-brian" name="question-answer" value="Brian">
            <label for="radio-brian">Brian</label>
            <input type="radio" id="radio-none" name="question-answer" value="None" checked>
            <label for="radio-none">None</label>
            <br>
            <input id="question-submit" type="submit" value="Ask!">
          </span>
        </form>
      </div>
      <div id="samples">
        <div id="samples-title">Premade Questions</div>
      </div>
      <div id="stats">
        <div id="answers-title">Answers</div>
        <div id="current-answers">
        </div>
        <div id="standings-title">Standings</div>
        <div id="standings">
          <br><br>
        </div>
      </div>
    </div>
  </body>

  <script>
    window.onbeforeunload = (e) => {
      return "Are you sure you want to leave?"
    }

    function shuffle(array) {
      let currentIndex = array.length;

      // While there remain elements to shuffle...
      while (currentIndex != 0) {

        // Pick a remaining element...
        let randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
    }

    const host = location.hostname === "localhost" ? "http://localhost:3000" : "https://perch.birdtown.net";
    const interval = 3000;

    let params = new URLSearchParams(window.location.search);
    if (params.has("new")) {
        fetch(`${host}/start`, { method: "PUT" });
    }

    let sampleQuestions = [
      ["Who is better at Tetris?", "Sharon"],
      ["Who said 'I love you' first?", "Sharon"],
      ["Who is more likely to forget birthdays?", "Sharon"],
      ["Who sleeps more?", "Sharon"],
      ["Who is older?", "Sharon"],

      ["Who is more musical?", "Brian"],
      ["Who has been working for longer?", "Brian"],
      ["Who cooks more?", "Brian"],
      ["Who made this thing?", "Brian"],

      ["Who will get more votes?", ""],
      ["Who is funnier?", ""],
      ["Who is messier?", ""],
      ["Most likely become a humble farmer", ""],
      ["Most likely to start a revolution", ""],
      ["Most likely to survive a zombie apocalypse", ""],
    ];
    shuffle(sampleQuestions);
    let sampleIndex = 0;
    let questionAnswer = "";

    let input = document.getElementById("question-input");
    let submit = document.getElementById("question-submit");
    let currentAnswers = document.getElementById("current-answers");
    let standings = document.getElementById("standings");
    let samples = document.getElementById("samples");

    let questionElm = null;
    let answersElm = new Map();

    let allowSubmit = true;
    let shouldRefresh = false;
    let version = 0;

    document.getElementById("radio-sharon").onclick = () => {
      questionAnswer = "Sharon";
    };
    document.getElementById("radio-brian").onclick = () => {
      questionAnswer = "Brian";
    };
    document.getElementById("radio-none").onclick = () => {
      questionAnswer = "";
    };

    function addSample() {
      if (sampleIndex >= sampleQuestions.length) {
        return;
      }

      const [question, answer] = sampleQuestions[sampleIndex];
      let q = document.createElement("div");
      q.classList.add("sample");
      q.textContent = question + (answer.length > 0 ? ` [${answer}]` : " [Opinion]");
      samples.appendChild(q);

      q.onclick = () => {
        q.style.display = "none";
        askQuestion(question, answer);
        addSample();
      }

      sampleIndex++;
    }
    for (let i = 0; i < 5; ++i) {
      addSample();
    }

    function setEnabled(enabled) {
      if (allowSubmit === enabled) {
        return;
      }

      if (enabled) {
        input.value = "";
        submit.value = "Ask!";        
      } else {
        submit.value = "Asking...";
      }
      allowSubmit = enabled;
    }

    submit.onclick = () => {
      askQuestion(input.value.trim(), questionAnswer);
    };

    function askQuestion(question, questionAnswer) {
      if (!allowSubmit) {
        return;
      }

      if (question.length <= 0) {
        return;
      }

      if (questionAnswer.length <= 0) {
        question = "[Opinion] " + question;
      }

      setEnabled(false);
      fetch(`${host}/ask?q=${question}&a=${questionAnswer}`, { method: "PUT" })
        .then((response) => {
          if (response.ok) {
            setEnabled(true);
            shouldRefresh = true;
            setQuestion(question, questionAnswer);
          } else {
            setQuestion("Error: failed to ask question", "");
            setEnabled(true);
          }
        });
    }

    function setQuestion(question, answer) {
      questionElm = document.createElement("div");
      questionElm.classList.add("question");
      currentAnswers.appendChild(questionElm);

      questionElm.textContent = question;

      if (answer.length > 0) {
        questionElm.textContent += ` [${answer}]`;
      }
      answersElm.clear();
    }

    function populateAnswers(answer, names) {
      if (!answersElm.has(answer)) {
        return;
      }

      let elm = answersElm.get(answer);
      elm.textContent = `${answer} (${names.length}): ${names.join(", ")}`;
    }

    function populateStats(data) {
      for (const key in data) {
        if (!data.hasOwnProperty(key)) {
          continue;
        }

        if (!answersElm.has(key)) {
          let answerElm = document.createElement("div");
          answerElm.classList.add("answer");
          currentAnswers.appendChild(answerElm);
          answersElm.set(key, answerElm);
        }

        populateAnswers(key, data[key]);
      }
    }

    function populateStandings(data) {
      let scores = [];
      standings.textContent = "";

      console.log("data", data);

      for (const key in data) {
        if (!data.hasOwnProperty(key)) {
          console.error("Bad key", key);
          continue;
        }

        const voter = data[key];

        if (!voter.hasOwnProperty("name") || !voter.hasOwnProperty("score")) {
          console.error("Invalid voter", voter);
          continue;
        }

        scores.push([voter["name"], Number(voter["score"])]);
      }

      console.log(scores);

      scores.sort((a, b) => {
        return b[1] - a[1];
      });

      standings.textContent = scores.map((pair, index) => `${index + 1}. ${pair[0]}: ${pair[1]}`).join("\n");
    }

    setInterval(() => {
      if (shouldRefresh) {
        fetch(`${host}/refreshAnswers`, { method: "GET" })
          .then((response) => response.json(), () => {})
          .then((data) => {
            populateStats(data);
          }, () => {});
      }

      fetch(`${host}/standings`, { method: "GET" })
        .then((response) => response.json(), () => {})
        .then((data) => {
          populateStandings(data);
        }, () => {});
    }, interval);
  </script>
</html>
